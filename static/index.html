<!DOCTYPE html>
<html lang="de">
<head>
  <meta charset="UTF-8" />
  <title>Bayern Formular Helper - KI-gest√ºtzte Formularhilfe</title>
  <style>
    body {
      font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      margin: 0;
      padding: 0;
      min-height: 100vh;
    }

    .header {
      background: rgba(255, 255, 255, 0.95);
      padding: 20px;
      box-shadow: 0 2px 10px rgba(0,0,0,0.1);
      display: flex;
      justify-content: space-between;
      align-items: center;
    }

    .header h1 {
      margin: 0;
      color: #333;
      font-size: 2em;
      font-weight: 300;
    }

    .header-nav {
      display: flex;
      gap: 20px;
    }

    .header-nav a {
      color: #667eea;
      text-decoration: none;
      padding: 10px 20px;
      border-radius: 20px;
      transition: all 0.3s;
      font-weight: 500;
    }

    .header-nav a:hover {
      background: #667eea;
      color: white;
    }

    .main-container {
      padding: 20px;
      max-width: 1200px;
      margin: 0 auto;
    }

    .welcome-section {
      background: rgba(255, 255, 255, 0.95);
      padding: 30px;
      border-radius: 15px;
      margin-bottom: 30px;
      box-shadow: 0 5px 15px rgba(0,0,0,0.1);
    }

    .welcome-section h2 {
      color: #333;
      margin-bottom: 15px;
    }

    .welcome-section p {
      color: #666;
      line-height: 1.6;
      margin-bottom: 20px;
    }

    .user-section {
      background: #e7f3ff;
      padding: 20px;
      border-radius: 10px;
      border-left: 4px solid #0066cc;
      margin-bottom: 20px;
    }

    .user-section h3 {
      margin: 0 0 10px 0;
      color: #0066cc;
    }

    .user-input-group {
      display: flex;
      gap: 10px;
      align-items: center;
    }

    .user-input-group input {
      flex: 1;
      padding: 10px;
      border: 2px solid #ddd;
      border-radius: 5px;
      font-size: 16px;
    }

    .user-input-group button {
      background: #0066cc;
      color: white;
      border: none;
      padding: 10px 20px;
      border-radius: 5px;
      cursor: pointer;
      font-weight: 500;
    }

    .user-input-group button:hover {
      background: #0052a3;
    }

    #pdf-list {
      background: rgba(255, 255, 255, 0.95);
      padding: 20px;
      border-radius: 15px;
      box-shadow: 0 5px 15px rgba(0,0,0,0.1);
    }

    #pdf-list h3 {
      color: #333;
      margin-bottom: 20px;
    }

    #pdf-list a {
      display: block;
      margin: 8px 0;
      text-decoration: none;
      color: #007bff;
      cursor: pointer;
      padding: 10px;
      border-radius: 5px;
      transition: background 0.3s;
    }

    #pdf-list a:hover {
      background: #f8f9fa;
      text-decoration: underline;
    }

    #chat-pdf-container {
      display: none;
      height: 90vh;
      padding: 20px;
      display: flex;
      gap: 20px;
    }

    #pdf-panel {
      flex: 1;
      display: flex;
      flex-direction: column;
      border: 1px solid #ccc;
      background: white;
      border-radius: 10px;
      overflow: hidden;
    }

    #pdf-panel h3 {
      margin: 10px;
      color: #333;
    }

    #pdf-viewer {
      flex: 1;
      border: none;
    }

    #chat-container {
      flex: 1;
      display: flex;
      flex-direction: column;
      border: 1px solid #ccc;
      background: white;
      border-radius: 10px;
      overflow: hidden;
    }

    #chat-box {
      flex: 1;
      overflow-y: auto;
      padding: 10px;
      background: #fff;
    }

    .msg {
      margin: 8px 0;
      padding: 6px 10px;
      border-radius: 6px;
      max-width: 70%;
    }

    .user {
      background: #d1e7dd;
      align-self: flex-end;
    }

    .bot {
      background: #f8d7da;
      align-self: flex-start;
    }

    #input-area {
      display: flex;
      border-top: 1px solid #ccc;
      background: #fff;
    }

    #user-input {
      flex: 1;
      padding: 10px;
      border: none;
      outline: none;
      font-size: 16px;
    }

    #send-btn {
      padding: 10px 20px;
      background: #007bff;
      color: white;
      border: none;
      cursor: pointer;
    }

    #send-btn:hover {
      background: #0056b3;
    }

    .hidden {
      display: none !important;
    }

    #back-btn {
      margin: 10px;
      padding: 5px 10px;
      cursor: pointer;
      background: #6c757d;
      color: white;
      border: none;
      border-radius: 4px;
      align-self: flex-start;
    }

    #back-btn:hover {
      background: #5a6268;
    }
  </style>
</head>
<body>
  <div class="header">
    <h1>üèõÔ∏è Bayern Formular Helper</h1>
    <div class="header-nav">
      <a href="/register">Registrieren</a>
      <a href="#" onclick="showProfilePrompt()">Mein Profil</a>
    </div>
  </div>

  <div class="main-container">
    <div class="welcome-section">
      <h2>Willkommen beim Bayern Formular Helper</h2>
      <p>
        Diese KI-gest√ºtzte Anwendung hilft dir beim Ausf√ºllen deutscher Beh√∂rdenformulare. 
        Registriere dich, um personalisierte Hilfe zu erhalten, oder nutze die allgemeine KI-Unterst√ºtzung.
      </p>
      
      <div class="user-section">
        <h3>üéØ Personalisierte KI-Hilfe</h3>
        <p>Gib deine Benutzer-ID ein, um personalisierte Hilfe beim Ausf√ºllen von Formularen zu erhalten:</p>
        <div class="user-input-group">
          <input type="text" id="user-id-input" placeholder="Deine Benutzer-ID hier eingeben...">
          <button onclick="setUserId()">Aktivieren</button>
        </div>
        <p style="margin: 10px 0 0 0; font-size: 14px; color: #666;">
          <strong>Aktuell:</strong> <span id="current-user-status">Keine Benutzer-ID eingegeben</span>
        </p>
      </div>
    </div>

    <div id="pdf-list">
      <h3>üìã Verf√ºgbare Formulare</h3>
      <div id="pdf-files"></div>
    </div>

    <div id="chat-pdf-container" class="hidden">
      <div id="pdf-panel">
        <h3 id="pdf-title">PDF Viewer</h3>
        <iframe id="pdf-viewer" src=""></iframe>
      </div>
      <div id="chat-container">
        <div id="chat-box"></div>
        <div id="input-area">
          <input type="text" id="user-input" placeholder="Frage die KI nach Hilfe beim Formular...">
          <button id="send-btn">Senden</button>
        </div>
        <button id="back-btn">‚Üê Zur√ºck zu den Formularen</button>
      </div>
    </div>
  </div>

  <script>
    let currentUserId = null;
    let currentPdfName = null;
    let currentPdfText = "";

    // Benutzer-ID setzen
    function setUserId() {
      const userIdInput = document.getElementById('user-id-input');
      const userId = userIdInput.value.trim();
      
      if (userId) {
        currentUserId = userId;
        document.getElementById('current-user-status').textContent = `Benutzer-ID: ${userId}`;
        userIdInput.value = '';
        
        // Pr√ºfen ob Benutzer existiert
        checkUserExists(userId);
      }
    }

    // Pr√ºfen ob Benutzer existiert
    async function checkUserExists(userId) {
      try {
        const response = await fetch(`/user/${userId}`);
        if (!response.ok) {
          alert('Benutzer-ID nicht gefunden. Bitte registriere dich zuerst.');
          currentUserId = null;
          document.getElementById('current-user-status').textContent = 'Keine Benutzer-ID eingegeben';
        }
      } catch (error) {
        console.error('Fehler beim Pr√ºfen der Benutzer-ID:', error);
      }
    }

    // Profil-Prompt anzeigen
    function showProfilePrompt() {
      const userId = prompt('Gib deine Benutzer-ID ein, um dein Profil zu bearbeiten:');
      if (userId) {
        window.open(`/profile.html?id=${userId}`, '_blank');
      }
    }

    // PDF-Liste laden
    async function loadPdfs() {
      try {
        const response = await fetch('/pdfs');
        const pdfs = await response.json();
        
        const pdfFilesDiv = document.getElementById('pdf-files');
        pdfFilesDiv.innerHTML = '';
        
        pdfs.forEach(pdf => {
          const link = document.createElement('a');
          link.textContent = pdf.title;
          link.onclick = () => openPdf(pdf.file_name, pdf.title);
          pdfFilesDiv.appendChild(link);
        });
      } catch (error) {
        console.error('Fehler beim Laden der PDFs:', error);
      }
    }

    // PDF √∂ffnen
    async function openPdf(pdfName, title) {
      currentPdfName = pdfName;
      
      document.getElementById('pdf-title').textContent = title;
      document.getElementById('pdf-viewer').src = `/static/pdfs/${pdfName}`;
      document.getElementById('chat-pdf-container').classList.remove('hidden');
      
      // Chat-Box leeren
      document.getElementById('chat-box').innerHTML = '';
      
      // PDF-Text laden f√ºr KI
      try {
        const response = await fetch(`/pdfs/${pdfName}/text`);
        if (response.ok) {
          const data = await response.json();
          currentPdfText = data.text || "";
          addMessage('bot', `Willkommen! Ich helfe dir beim Ausf√ºllen von "${title}". Wie kann ich dir helfen?`);
        } else {
          addMessage('bot', `Willkommen! Ich helfe dir beim Ausf√ºllen von "${title}". Wie kann ich dir helfen?`);
        }
      } catch (error) {
        console.error('Fehler beim Laden des PDF-Texts:', error);
        addMessage('bot', `Willkommen! Ich helfe dir beim Ausf√ºllen von "${title}". Wie kann ich dir helfen?`);
      }
    }

    // Nachricht hinzuf√ºgen
    function addMessage(sender, message) {
      const chatBox = document.getElementById('chat-box');
      const msgDiv = document.createElement('div');
      msgDiv.className = `msg ${sender}`;
      msgDiv.textContent = message;
      chatBox.appendChild(msgDiv);
      chatBox.scrollTop = chatBox.scrollHeight;
    }

    // Chat senden
    async function sendMessage() {
      const input = document.getElementById('user-input');
      const message = input.value.trim();
      
      if (!message) return;
      
      addMessage('user', message);
      input.value = '';
      
      try {
        // Erweiterte Eingabe mit PDF-Kontext
        const enhancedInput = `PDF: ${currentPdfName}\nPDF Content: ${currentPdfText}\nUser: ${message}`;
        
        const requestBody = {
          user_input: enhancedInput,
          user_id: currentUserId
        };
        
        const response = await fetch('/chat', {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json',
          },
          body: JSON.stringify(requestBody)
        });
        
        const result = await response.json();
        addMessage('bot', result.response);
        
      } catch (error) {
        console.error('Fehler beim Senden der Nachricht:', error);
        addMessage('bot', 'Entschuldigung, es gab einen Fehler. Bitte versuche es erneut.');
      }
    }

    // Zur√ºck zu PDFs
    function backToPdfs() {
      document.getElementById('chat-pdf-container').classList.add('hidden');
      document.getElementById('chat-box').innerHTML = '';
      currentPdfName = null;
      currentPdfText = "";
      document.getElementById('pdf-viewer').src = "";
    }

    // Event Listener
    document.getElementById('send-btn').onclick = sendMessage;
    document.getElementById('user-input').onkeypress = function(e) {
      if (e.key === 'Enter') {
        sendMessage();
      }
    };
    document.getElementById('back-btn').onclick = backToPdfs;

    // Seite laden
    loadPdfs();
  </script>
</body>
</html>