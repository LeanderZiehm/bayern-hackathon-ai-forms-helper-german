<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>PDF Chat & Form Filler</title>
  <style>
    body { font-family: sans-serif; margin: 0; padding: 0; background: #f5f5f5; }
    #pdf-list { padding: 20px; }
    #pdf-list a { display: block; margin: 5px 0; text-decoration: none; color: #007bff; cursor: pointer; }
    #pdf-list a:hover { text-decoration: underline; }
    #chat-pdf-container { display: none; height: 90vh; padding: 20px; display: flex; gap: 20px; }
    #pdf-panel { flex: 1; display: flex; flex-direction: column; border: 1px solid #ccc; background: white; overflow: auto; }
    #pdf-panel h3 { margin: 10px; }
    #pdf-container { flex: 1; position: relative; overflow-y: auto; padding: 10px; }
    #chat-container { flex: 1; display: flex; flex-direction: column; border: 1px solid #ccc; background: white; }
    #chat-box { flex: 1; overflow-y: auto; padding: 10px; background: #fff; }
    .msg { margin: 8px 0; padding: 6px 10px; border-radius: 6px; max-width: 70%; }
    .user { background: #d1e7dd; align-self: flex-end; }
    .bot { background: #f8d7da; align-self: flex-start; }
    #input-area { display: flex; border-top: 1px solid #ccc; background: #fff; }
    #user-input { flex: 1; padding: 10px; border: none; outline: none; font-size: 16px; }
    #send-btn { padding: 10px 20px; border: none; background: #007bff; color: white; cursor: pointer; }
    #send-btn:hover { background: #0056b3; }
    #back-btn { margin: 10px; padding: 5px 10px; cursor: pointer; background: #6c757d; color: white; border: none; border-radius: 4px; align-self: flex-start; }
    #back-btn:hover { background: #5a6268; }
    .textLayer { position: absolute; top: 0; left: 0; color: transparent; line-height: 1; white-space: pre; pointer-events: none; }
    .textLayer span { position: absolute; white-space: pre; transform-origin: 0% 0%; pointer-events: all; cursor: text; }
    .pdf-form-input { position: absolute; border: 1px solid #333; box-sizing: border-box; font-size: 14px; padding: 2px; background: rgba(255,255,255,0.8); }
  </style>

  <!-- PDF.js -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/pdf.js/2.6.347/pdf.min.js"></script>
  <script>
    pdfjsLib.GlobalWorkerOptions.workerSrc = "https://cdnjs.cloudflare.com/ajax/libs/pdf.js/2.6.347/pdf.worker.min.js";
  </script>
</head>
<body>

<div id="pdf-list">
  <h2>Select a PDF:</h2>
  <div id="pdf-links"></div>
</div>

<div id="chat-pdf-container">
  <div id="pdf-panel">
    <h3 id="pdf-title"></h3>
    <div id="pdf-container"></div>
  </div>

  <div id="chat-container">
    <div id="chat-box"></div>
    <div id="input-area">
      <input id="user-input" type="text" placeholder="Type a message..." />
      <button id="send-btn">Send</button>
    </div>
    <button id="back-btn">‚Üê Back to PDFs</button>
  </div>
</div>

<script>
  const pdfLinksDiv = document.getElementById("pdf-links");
  const pdfListDiv = document.getElementById("pdf-list");
  const chatPdfContainer = document.getElementById("chat-pdf-container");
  const pdfTitle = document.getElementById("pdf-title");
  const pdfContainer = document.getElementById("pdf-container");
  const chatBox = document.getElementById("chat-box");
  const userInput = document.getElementById("user-input");
  const sendBtn = document.getElementById("send-btn");
  const backBtn = document.getElementById("back-btn");

  let currentPdf = "";
  let currentPdfText = "";

  // Load PDFs dynamically from server
  async function loadPDFs() {
    try {
      const res = await fetch("/pdfs"); // Your endpoint that returns JSON list
      const pdfs = await res.json();     // Example: [{ file_name: "file1.pdf", title: "PDF 1" }, ...]
      pdfLinksDiv.innerHTML = "";
      pdfs.forEach(pdf => {
        const link = document.createElement("a");
        link.textContent = pdf.title || pdf.file_name;
        link.href = "#";
        link.addEventListener("click", () => openChat(pdf.file_name));
        pdfLinksDiv.appendChild(link);
      });
    } catch (err) {
      pdfLinksDiv.textContent = "Failed to load PDFs.";
      console.error(err);
    }
  }

  async function openChat(pdfName) {
    currentPdf = pdfName;
    pdfTitle.textContent = pdfName;
    chatBox.innerHTML = "";
    chatPdfContainer.style.display = "flex";
    pdfListDiv.style.display = "none";
    pdfContainer.innerHTML = "";

    const pdfUrl = `/static/pdfs/${pdfName}`;
    const pdf = await pdfjsLib.getDocument(pdfUrl).promise;

    for (let pageNum = 1; pageNum <= pdf.numPages; pageNum++) {
      const page = await pdf.getPage(pageNum);
      const scale = 1.5;
      const viewport = page.getViewport({ scale });

      const pageDiv = document.createElement("div");
      pageDiv.style.position = "relative";
      pageDiv.style.marginBottom = "20px";
      pageDiv.style.width = viewport.width + "px";
      pageDiv.style.height = viewport.height + "px";

      const canvas = document.createElement("canvas");
      canvas.width = viewport.width;
      canvas.height = viewport.height;
      pageDiv.appendChild(canvas);
      const ctx = canvas.getContext("2d");
      await page.render({ canvasContext: ctx, viewport }).promise;

      // Text layer
      const textContent = await page.getTextContent();
      const textLayerDiv = document.createElement("div");
      textLayerDiv.className = "textLayer";
      textLayerDiv.style.height = canvas.height + "px";
      textLayerDiv.style.width = canvas.width + "px";
      textLayerDiv.style.color = "black";
      pageDiv.appendChild(textLayerDiv);

      pdfjsLib.renderTextLayer({
        textContent,
        container: textLayerDiv,
        viewport,
        textDivs: []
      });

      await applyAnnotations(page,scale,canvas,pageDiv);

    // Optional: fetch PDF text from backend for chat AI
    currentPdfText = "";
  }}


  async function applyAnnotations(page,scale,canvas,pageDiv){
// Form fields
const annotations = await page.getAnnotations();
annotations.forEach(ann => {
    if (ann.fieldName === "SYSTEM_P1_DUMMY") return; // skip

    if (ann.subtype === 'Widget') {
        const [x1, y1, x2, y2] = ann.rect;
        const width = (x2 - x1) * scale;
        const height = (y2 - y1) * scale;

        // Use textarea if multiLine, checkbox if checkbox, otherwise input
        let input;
        if (ann.fieldType === 'Btn' && ann.checkBox) {
            input = document.createElement("input");
            input.type = "checkbox";
        } else if (ann.multiLine) {
            input = document.createElement("textarea");
        } else {
            input = document.createElement("input");
            input.type = "text";
        }

        input.className = "pdf-form-input";
        input.value =  ann.fieldValue || ann.fieldName;//"";
        input.id = ann.fieldName;

        // Positioning
        input.style.position = "absolute";
        input.style.left = x1 * scale + "px";
        input.style.top = (canvas.height - y2 * scale) + "px"; // flip Y
        input.style.width = width + "px";
        input.style.height = height + "px";
        input.style.boxSizing = "border-box";
        input.style.padding = "2px";

        // Readonly
        if (ann.readOnly) input.readOnly = true;

        // Max length
        if (ann.maxLen) input.maxLength = ann.maxLen;

        // Text alignment
        if (ann.textAlignment !== null) {
            const alignMap = ["left", "center", "right"];
            input.style.textAlign = alignMap[ann.textAlignment] || "left";
        }

        // Font and color from defaultAppearance
        if (ann.defaultAppearance) {
            const da = ann.defaultAppearance.match(/\/(\w+)\s+([\d.]+)\s+Tf\s+([\d.]+)\s+g/);
            if (da) {
                const font = da[1];
                const fontSize = da[2];
                const color = parseFloat(da[3]) * 255;
                input.style.fontFamily = font; // You may map to web fonts if needed
                input.style.fontSize = fontSize + "px";
                input.style.color = `rgb(${color},${color},${color})`;
            }
        }

        pageDiv.appendChild(input);
    }
});

pdfContainer.appendChild(pageDiv);

  }

  function backToPDFs() {
    chatPdfContainer.style.display = "none";
    pdfListDiv.style.display = "block";
    chatBox.innerHTML = "";
    pdfContainer.innerHTML = "";
    currentPdf = "";
    currentPdfText = "";
  }

  function addMessage(content, sender) {
    const msg = document.createElement("div");
    msg.classList.add("msg", sender);
    msg.textContent = content;
    chatBox.appendChild(msg);
    chatBox.scrollTop = chatBox.scrollHeight;
  }

  sendBtn.addEventListener("click", () => {
    const text = userInput.value.trim();
    if (!text) return;
    addMessage(text, "user");
    userInput.value = "";
  });

  userInput.addEventListener("keypress", (e) => {
    if (e.key === "Enter") sendBtn.click();
  });

  backBtn.addEventListener("click", backToPDFs);

  document.addEventListener("selectionchange", () => {
    const text = window.getSelection().toString().trim();
    if (text) console.log("Selected text:", text);
  });

  loadPDFs();
</script>
</body>
</html>
